import React, { useState } from 'react';
import { useAuth } from '../context/AuthContext';
import useDecrypt from '../utils/useDecrypt';
import useDynamicQuery from '../services/useDynamicQuery';
import { useParams, useNavigate } from 'react-router-dom';
import { Tab } from 'react-bootstrap';
import { FormatDate } from '../utils/FormatDate';
import SpeedGaugeChart from '../components/SpeedGaugeChart';
import { SwitchTabComp } from '../components/SwitchTabComp';
import TableComp from '../components/TableComp';
import { NoData } from '../shared/NoData';
import OverlayTrigger from 'react-bootstrap/OverlayTrigger';
import Tooltip from 'react-bootstrap/Tooltip';

const VulnerabilityDetails = () => {
    const { id } = useParams();
    const navigate = useNavigate();
    const user = useAuth();
    const orgId = useDecrypt(user?.activeOrgId);
    const queryParams = { vul_id: id, orgId: orgId };
    const [selectedTab, setSelectedTab] = useState('General Information');
    const getSelectedTab = (val) => {
        setSelectedTab(val);
    };

    const { data = {} } = useDynamicQuery({
        type: 'get',
        url: `vulnerabilities/details/${id}`,
        query_name: 'getVulnerabilityDetails',
        params: queryParams,
    });

    const { data: assetData = {} } = useDynamicQuery({
        type: 'get',
        url: `vulnerabilities/assets/${id}`,
        query_name: 'getVulnerabilityAssetDetails',
        params: queryParams,
        // enabled: false,
    });
    const {
        // id,
        name,
        description,
        severity,
        discovered_date,
        updated_on,
        published_date,
        patch_priority,
        solution,
        workaround,
        impact,
        result,
        last_found,
        status,
        exploitability,
        risk_score,
        cve_data,
    } = data?.data || {};

    const { data: cvesData = {} } = useDynamicQuery({
        type: 'get',
        url: `vulnerabilities/patch-cve/${id}`,
        query_name: 'getVulnerabilityCvesDetails',
        params: queryParams,
    });

    return (
        <>
            <div className="inner-page-details">
                <div className="d-flex align-items-center gap-3">
                    <div className="back-to cursor-pointer m-l-30" onClick={() => navigate(-1)}>
                        <img src="/images/left-arrow.svg" alt="back_arrow" />
                    </div>
                    <div className="inner-page-heading">
                        <h2>{name}</h2>
                        <div className="date-preview d-flex gap-3">
                            <span>
                                <span>Published Date : </span>
                                <span>{FormatDate(published_date)}</span>
                            </span>
                            <span>
                                <span>Discovered Date : </span>
                                <span>{FormatDate(discovered_date)}</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div className="m-t-20">
                <Tab.Container defaultActiveKey="General">
                    <div>
                        {/* <Nav variant="pills" className="flex-column">
                            <Nav.Item>
                                <Nav.Link eventKey="General">General Information</Nav.Link>
                            </Nav.Item>
                            <Nav.Item>
                                <div
                                    onClick={() => {
                                        patchesRefetch();
                                    }}>
                                    <Nav.Link eventKey="Patches">Patches</Nav.Link>
                                </div>
                            </Nav.Item>
                            <Nav.Item>
                                <div
                                    onClick={() => {
                                        exploitsRefetch();
                                    }}>
                                    <Nav.Link eventKey="Exploitability">Exploitability</Nav.Link>
                                </div>
                            </Nav.Item>
                        </Nav> */}
                        <SwitchTabComp
                            from="vulnerabilityDetails"
                            getSelectedTab={getSelectedTab}
                        />
                    </div>
                    <div className="m-t-20">
                        <Tab.Content>
                            <Tab.Pane eventKey="General">
                                {selectedTab === 'General Information' && (
                                    <div className="assets-wrapper m-t-20">
                                        <div className="assets-grid">
                                            <div className="width-30 leftside-card">
                                                <div className="asset-container">
                                                    <div className="asset-title-sub">
                                                        Statistics
                                                    </div>
                                                    <div className="asset-title">
                                                        Detection Summary
                                                    </div>
                                                    <div className="divider-hr w-100"></div>
                                                    <div className="inner-page-heading">
                                                        <h2 className="fs-16">{name}</h2>
                                                        <div className="d-flex gap-2 m-b-30 align-items-center m-t-5 flex-sm-nowrap flex-wrap">
                                                            {status === 0 ? (
                                                                <div
                                                                    className={`vul-status vul-inactive`}>
                                                                    Inactive
                                                                </div>
                                                            ) : (
                                                                <div className="vul-active vul-status">
                                                                    Active
                                                                </div>
                                                            )}

                                                            <div className="date-preview sub-name-margin">
                                                                <span>Last found</span> :
                                                                <span>
                                                                    {' '}
                                                                    {last_found
                                                                        ? FormatDate(last_found)
                                                                        : '-'}
                                                                </span>
                                                            </div>
                                                            <div className="date-preview sub-name-margin">
                                                                <span>CVE</span> :
                                                                {!cve_data?.length && '-'}
                                                                {cve_data
                                                                    ?.slice(0, 1)
                                                                    ?.map((val, index) => (
                                                                        <span
                                                                            key={`${val}_${index}_CVE`}>
                                                                            {val}
                                                                        </span>
                                                                    ))}
                                                            </div>
                                                            {cve_data?.length - 1 > 0 && (
                                                                <div className="vul-status vul-more ">
                                                                    <OverlayTrigger
                                                                        key="bottom"
                                                                        placement="bottom"
                                                                        overlay={
                                                                            <Tooltip className="more-tooltip">
                                                                                {cve_data
                                                                                    ?.slice(
                                                                                        1,
                                                                                        cve_data?.length
                                                                                    )
                                                                                    ?.map(
                                                                                        (
                                                                                            val,
                                                                                            index
                                                                                        ) => (
                                                                                            <p
                                                                                                className="mb-2"
                                                                                                key={`${val}_${index}_CVE_tooltip`}>
                                                                                                {
                                                                                                    val
                                                                                                }
                                                                                            </p>
                                                                                        )
                                                                                    )}
                                                                            </Tooltip>
                                                                        }>
                                                                        <span>
                                                                            + {cve_data?.length - 1}
                                                                            &nbsp; More
                                                                        </span>
                                                                    </OverlayTrigger>
                                                                </div>
                                                            )}
                                                        </div>
                                                        <SpeedGaugeChart data={data?.data} />
                                                        <div>
                                                            <div className="chart-status-wrapper">
                                                                <div
                                                                    className="chart-status"
                                                                    style={{
                                                                        color:
                                                                            data?.risk_score >= 1 &&
                                                                            data?.risk_score <= 3
                                                                                ? '#8ECF56'
                                                                                : data?.risk_score >=
                                                                                        4 &&
                                                                                    data?.risk_score <=
                                                                                        6
                                                                                  ? '#FFD60A'
                                                                                  : data?.risk_score >=
                                                                                          7 &&
                                                                                      data?.risk_score <=
                                                                                          8
                                                                                    ? '#FFB933'
                                                                                    : data?.risk_score >=
                                                                                            9 &&
                                                                                        data?.risk_score <=
                                                                                            10
                                                                                      ? '#8ECF56'
                                                                                      : '#EA4444',
                                                                    }}>
                                                                    {risk_score ? risk_score : '-'}
                                                                </div>
                                                                {updated_on && (
                                                                    <div className="update-date-on">
                                                                        Updated{' '}
                                                                        {updated_on
                                                                            ? FormatDate(updated_on)
                                                                            : '-'}
                                                                    </div>
                                                                )}
                                                            </div>

                                                            <div className="d-flex gap-4 align-items-end justify-content-center m-t-30">
                                                                <div>
                                                                    <div
                                                                        className="text-muted"
                                                                        style={{
                                                                            fontSize: '14px',
                                                                        }}>
                                                                        Serverity {}
                                                                    </div>
                                                                    {severity ? (
                                                                        <div className="risk-img-vul">
                                                                            <img
                                                                                src={`/images/risk-scores/${severity?.toLowerCase()}.png`}
                                                                                alt="risk-scores"
                                                                            />
                                                                        </div>
                                                                    ) : (
                                                                        '-'
                                                                    )}
                                                                </div>
                                                                <div className="v-divider"></div>
                                                                <div>
                                                                    <div
                                                                        className="text-muted"
                                                                        style={{
                                                                            fontSize: '14px',
                                                                        }}>
                                                                        Patch Priority
                                                                    </div>
                                                                    {patch_priority ? (
                                                                        <div className="risk-img-vul">
                                                                            <img
                                                                                src={`/images/risk-scores/${patch_priority?.toLowerCase()}.png`}
                                                                                alt="patch-priority"
                                                                            />
                                                                        </div>
                                                                    ) : (
                                                                        '-'
                                                                    )}
                                                                </div>
                                                                <div className="v-divider"></div>
                                                                <div>
                                                                    <div
                                                                        className="text-muted"
                                                                        style={{
                                                                            fontSize: '14px',
                                                                        }}>
                                                                        Exploitability
                                                                    </div>
                                                                    {exploitability ? (
                                                                        <div className="risk-img-vul">
                                                                            <img
                                                                                src={`/images/risk-scores/${exploitability?.complexity?.toLowerCase()}.png`}
                                                                                alt="exploitability"
                                                                            />
                                                                        </div>
                                                                    ) : (
                                                                        '-'
                                                                    )}
                                                                </div>
                                                            </div>
                                                            <div className="primary-btn patch d-flex justify-content-center m-t-40 w-100">
                                                                <button
                                                                    type="button"
                                                                    className="outline-btn">
                                                                    Patch now
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="asset-container">
                                                    <div className="asset-title-sub">
                                                        Identification
                                                    </div>
                                                    <div className="asset-title">
                                                        Vulnerability result
                                                    </div>
                                                    <div className="divider-hr w-100"></div>
                                                    <div className="d-flex gap-4 align-items-baseline">
                                                        <div className="carr-img">
                                                            <img
                                                                src="/images/result.png"
                                                                alt="back_arrow"
                                                            />
                                                        </div>
                                                        <div className="card-details">
                                                            <div>{result ? result : '-'}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="asset-container">
                                                    <div className="asset-title-sub">
                                                        Information
                                                    </div>
                                                    <div className="asset-title">
                                                        Vulnerability description
                                                    </div>
                                                    <div className="divider-hr w-100"></div>
                                                    <div className="d-flex gap-4 align-items-baseline">
                                                        <div className="carr-img">
                                                            <img
                                                                src="/images/refresh-vulner.png"
                                                                alt="back_arrow"
                                                            />
                                                        </div>
                                                        <div className="card-details">
                                                            <div>
                                                                This security update contains the
                                                                following:
                                                            </div>
                                                            <div>{description}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="width-70 rightside-card">
                                                <div className="asset-container">
                                                    <div className="asset-title-sub">
                                                        Information
                                                    </div>
                                                    <div className="asset-title">About asset</div>
                                                    <div className="divider-hr w-100"></div>
                                                    {!assetData?.data?.data?.length && (
                                                        <div>No Asset Available</div>
                                                    )}
                                                    {assetData?.data?.data?.map((value, index) => (
                                                        <div
                                                            key={`${value?.ip_address_v6}_${index}_asset_details`}>
                                                            <div className="d-flex flex-wrap gap-4 m-t-20">
                                                                <div className="assets-content">
                                                                    <div className="asset-title-sub">
                                                                        Hostname
                                                                    </div>
                                                                    <div className="asset-title">
                                                                        {value?.host_name}
                                                                    </div>
                                                                </div>
                                                                <div className="assets-content">
                                                                    <div className="asset-title-sub">
                                                                        Host ID
                                                                    </div>
                                                                    <div className="asset-title">
                                                                        {value?.host_id}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className="d-flex flex-wrap gap-4 m-t-20">
                                                                <div className="assets-content">
                                                                    <div className="asset-title-sub">
                                                                        IPv4 Addresses
                                                                    </div>
                                                                    <div className="asset-title">
                                                                        {value?.ip_address_v4}
                                                                    </div>
                                                                </div>
                                                                <div className="assets-content">
                                                                    <div className="asset-title-sub">
                                                                        IPv6 Addresses
                                                                    </div>
                                                                    <div className="asset-title">
                                                                        {value?.ip_address_v6}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className="divider-hr w-100"></div>
                                                            <h5 className="fs-16">Activity</h5>
                                                            <div className="d-flex flex-wrap gap-4 m-t-20">
                                                                <div className="assets-content">
                                                                    <div className="asset-title-sub">
                                                                        Last User Login
                                                                    </div>
                                                                    <div className="asset-title">
                                                                        {value?.last_user_login
                                                                            ? FormatDate(
                                                                                  value?.last_user_login
                                                                              )
                                                                            : '-'}
                                                                    </div>
                                                                </div>
                                                                <div className="assets-content">
                                                                    <div className="asset-title-sub">
                                                                        created on
                                                                    </div>
                                                                    <div className="asset-title">
                                                                        {value?.created_on
                                                                            ? FormatDate(
                                                                                  value?.created_on
                                                                              )
                                                                            : '-'}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className="d-flex flex-wrap gap-4 m-t-20">
                                                                <div className="assets-content">
                                                                    <div className="asset-title-sub">
                                                                        Last System Boot
                                                                    </div>
                                                                    <div className="asset-title">
                                                                        {value?.last_system_boot
                                                                            ? FormatDate(
                                                                                  value?.last_system_boot
                                                                              )
                                                                            : '-'}
                                                                    </div>
                                                                </div>
                                                                <div className="assets-content">
                                                                    <div className="asset-title-sub">
                                                                        Last Activity
                                                                    </div>
                                                                    <div className="asset-title">
                                                                        {value?.last_activity
                                                                            ? FormatDate(
                                                                                  value?.last_activity
                                                                              )
                                                                            : '-'}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                                <div className="asset-container">
                                                    <div className="asset-title-sub">
                                                        Information
                                                    </div>
                                                    <div className="asset-title">Impact</div>
                                                    <div className="divider-hr w-100"></div>
                                                    <div className="d-flex gap-4 align-items-baseline">
                                                        <div className="carr-img">
                                                            <img
                                                                src="/images/warning.png"
                                                                alt="back_arrow"
                                                            />
                                                        </div>
                                                        <div className="card-details">
                                                            <div>{impact}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="asset-container">
                                                    <div className="asset-title-sub">
                                                        Information
                                                    </div>
                                                    <div className="asset-title">Solution</div>
                                                    <div className="divider-hr w-100"></div>
                                                    <div className="d-flex gap-4 align-items-baseline">
                                                        <div className="carr-img">
                                                            <img
                                                                src="/images/success.png"
                                                                alt="back_arrow"
                                                            />
                                                        </div>
                                                        <div className="card-details">
                                                            <div>{solution}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="asset-container w-100">
                                                <div className="asset-title-sub">Information</div>
                                                <div className="asset-title">Work arounds</div>
                                                <div className="divider-hr w-100"></div>
                                                <div className="d-flex gap-4 align-items-baseline">
                                                    <div className="carr-img">
                                                        <img
                                                            src="/images/work.png"
                                                            alt="back_arrow"
                                                        />
                                                    </div>
                                                    <div className="card-details">
                                                        <div>{workaround}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </Tab.Pane>
                            {/* <Tab.Pane eventKey="Patches"> */}
                            {selectedTab === 'Patches' && (
                                <div className="row patches-table">
                                    <div className="col-md-8 col-lg-10 col-sm-8">
                                        <TableComp from="vulpatches" />
                                    </div>
                                    <div className="col-md-3 col-lg-2 col-sm-4 table-section m-t-110">
                                        <div className="table-br mt-3">
                                            <table className="table CVE">
                                                <thead>
                                                    <tr>
                                                        <th scope="col" className="cves px-6 py-2">
                                                            Total CVEs (
                                                            {cvesData?.data?.data?.length})
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {!cvesData?.data?.data?.length && (
                                                        <tr>
                                                            <td colSpan={1}>
                                                                <NoData />
                                                            </td>
                                                        </tr>
                                                    )}
                                                    {cvesData?.data?.data?.map((user, index) => (
                                                        <tr key={`${user}_${index}_CVE_data`}>
                                                            <td className="CVE">
                                                                <div className="text-center">
                                                                    {user}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {/* <VulPatches data={patchesData?.data} /> */}
                            {/* </Tab.Pane> */}
                            {/* <Tab.Pane eventKey="Exploitability"> */}
                            {/* <VulExploits data={exploitsData?.data} /> */}
                            {selectedTab === 'Exploitability' && (
                                <div className="patches-table">
                                    {' '}
                                    <TableComp from="exploits" />
                                </div>
                            )}
                            {/* </Tab.Pane> */}
                        </Tab.Content>
                    </div>
                </Tab.Container>
            </div>
        </>
    );
};

export default VulnerabilityDetails;
